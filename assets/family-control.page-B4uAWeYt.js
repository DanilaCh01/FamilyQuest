import{r as m,j as e,b as x}from"./index-DSzY9glm.js";const j=({children:b,onRefresh:p})=>{const[n,u]=m.useState({}),[i,o]=m.useState(null),[h,s]=m.useState(""),c=async t=>{if(window.confirm(`Видалити дитину ${t}? Це видалить усі її дані!`))try{await x(`/users/children/${t}`,"DELETE"),p()}catch(l){console.error("Помилка при видаленні дитини:",l),alert("Помилка при видаленні дитини")}},g=async t=>{try{await x(`/users/children/${t}`,"PUT",{name:h}),o(null),p()}catch(l){console.error("Помилка при зміні імені:",l),alert("Помилка при зміні імені")}},r=async(t,l)=>{const d=Number(n[t]);if(!d||d<=0)return alert("Введіть суму");const f=l==="award"?"/family/points/award":"/family/points/deduct";try{await x(f,"POST",{childEmail:t,points:d,reason:"Оновлення через панель"}),u({...n,[t]:""}),p()}catch(a){console.error("Помилка при зміні балів:",a),alert("Помилка при зміні балів")}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Керування балами"}),b.map(t=>e.jsxs("div",{className:"flex flex-col p-4 bg-gray-50 rounded-xl border border-gray-100",children:[e.jsxs("div",{className:"flex justify-between mb-3",children:[e.jsxs("div",{children:[i===t.childEmail?e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 text-sm",value:h,onChange:l=>s(l.target.value),autoFocus:!0}),e.jsx("button",{onClick:()=>g(t.childEmail),className:"text-green-600 text-xs font-bold",children:"ОК"}),e.jsx("button",{onClick:()=>o(null),className:"text-gray-400 text-xs",children:"Скасувати"})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-bold",children:t.name||t.childEmail}),e.jsx("button",{onClick:()=>{o(t.childEmail),s(t.name||"")},className:"text-gray-400 hover:text-blue-500 text-xs",children:"edit"})]}),e.jsx("p",{className:"text-xs text-gray-400",children:t.childEmail})]}),e.jsx("button",{onClick:()=>c(t.childEmail),className:"text-red-300 hover:text-red-500 text-xs",children:"Видалити"})]}),e.jsxs("span",{className:"font-bold text-blue-600 text-sm mb-3",children:[t.balance," ★"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",placeholder:"Сума",className:"flex-1 p-2 rounded border outline-none focus:ring-2 focus:ring-blue-400",value:n[t.childEmail]||"",onChange:l=>u({...n,[t.childEmail]:l.target.value})}),e.jsx("button",{onClick:()=>r(t.childEmail,"award"),className:"px-4 py-2 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600",children:"+"}),e.jsx("button",{onClick:()=>r(t.childEmail,"deduct"),className:"px-[18px] py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600",children:"-"})]})]},t.childEmail))]})},N=({goals:b,childrenList:p,onRefresh:n})=>{const[u,i]=m.useState(!1),[o,h]=m.useState(null),[s,c]=m.useState({title:"",points:"",childEmail:""}),g=async()=>{await x("/family/goals","POST",{title:s.title,points:Number(s.points),childEmail:s.childEmail})},r=async a=>{await x(`/family/goals/${a}`,"PUT",{title:s.title,points:Number(s.points),childEmail:s.childEmail})},t=async a=>{if(window.confirm("Видалити цю ціль?"))try{await x(`/family/goals/${a}`,"DELETE"),n()}catch(y){console.error("Помилка при видаленні цілі:",y),alert("Помилка при видаленні цілі")}},l=async()=>{if(!s.title||!s.points||!s.childEmail)return alert("Заповніть всі поля та оберіть дитину");try{o?await r(o):await g(),f(),n()}catch(a){console.error("Помилка при збереженні цілі:",a),alert("Помилка при збереженні")}},d=a=>{h(a.id),c({title:a.title,points:a.points,childEmail:a.childEmail||""}),i(!1)},f=()=>{i(!1),h(null),c({title:"",points:"",childEmail:""})};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800",children:"Цілі сім'ї"}),!u&&!o&&e.jsx("button",{onClick:()=>i(!0),className:"text-blue-600 font-bold hover:underline",children:"+ Додати"})]}),(u||o)&&e.jsxs("div",{className:"bg-blue-50 p-4 rounded-xl space-y-3 border border-blue-100 shadow-inner",children:[e.jsx("p",{className:"text-xs font-bold text-blue-400 uppercase",children:o?"Редагування цілі":"Нова ціль"}),e.jsx("input",{placeholder:"Назва",className:"w-full p-2 rounded border",value:s.title,onChange:a=>c({...s,title:a.target.value})}),e.jsx("input",{type:"number",placeholder:"Бали",className:"w-full p-2 rounded border",value:s.points,onChange:a=>c({...s,points:a.target.value})}),e.jsxs("select",{className:"w-full p-2 rounded border bg-white",value:s.childEmail,onChange:a=>c({...s,childEmail:a.target.value}),children:[e.jsx("option",{value:"",children:"Оберіть дитину"}),p?.map(a=>e.jsx("option",{value:a.email||a.childEmail,children:a.name||a.email||a.childEmail},a.email||a.childEmail))]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:l,className:"bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold",children:"Зберегти"}),e.jsx("button",{onClick:f,className:"text-gray-500 text-sm",children:"Скасувати"})]})]}),e.jsx("ul",{className:"space-y-2",children:b.map(a=>e.jsxs("li",{className:"flex justify-between p-3 bg-white border rounded-lg shadow-sm group",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:a.title}),e.jsxs("span",{className:"text-[10px] text-gray-400 italic",children:["Для: ",a.childEmail]})," "]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"font-bold text-blue-600",children:[a.points," ★"]}),e.jsxs("div",{className:"flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:()=>d(a),className:"text-gray-400 hover:text-blue-500 mr-2",children:"edit"}),e.jsx("button",{onClick:()=>t(a.id),className:"text-gray-400 hover:text-red-500",children:"✕"})]})]})]},a.id))})]})},w=()=>{const[b,p]=m.useState(!0),[n,u]=m.useState({profile:null,children:[],goals:[]}),[i,o]=m.useState(!1),[h,s]=m.useState(""),c=async()=>{let r={};try{(await x("/users")).children?.forEach(l=>{r[l.email]=l.name})}catch(t){console.error("Помилка завантаження імен дітей:",t)}try{const t=await x("/family/profile");u(l=>({...l,profile:t})),s(t.name||"")}catch(t){console.error("Помилка завантаження профілю:",t)}try{const l=(await x("/family/points/balances")).map(d=>({...d,name:r[d.childEmail]||d.name||""}));u(d=>({...d,children:l}))}catch(t){console.error("Помилка завантаження балансів:",t)}try{const t=await x("/family/goals");u(l=>({...l,goals:t}))}catch(t){console.error("Помилка завантаження цілей:",t)}p(!1)};m.useEffect(()=>{(async()=>await c())()},[]);const g=async()=>{if(i)try{const r=await x("/family/profile","PUT",{name:h});u(t=>({...t,profile:{...t.profile,name:r.name}}))}catch(r){console.error("Помилка збереження назви сім'ї:",r),s(n.profile?.name||"")}o(!i)};return b?e.jsx("p",{className:"text-center mt-10 animate-pulse",children:"Завантаження панелі керування..."}):e.jsxs("div",{className:"max-w-6xl mx-auto p-6 space-y-8",children:[e.jsxs("section",{className:"bg-white p-6 rounded-2xl shadow-sm border border-gray-100",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-800",children:["Сім'я:"," ",i?e.jsx("input",{type:"text",className:"border-b-2 border-blue-500 outline-none px-2 py-1 font-medium",value:h,onChange:r=>s(r.target.value),autoFocus:!0}):e.jsx("span",{className:"text-blue-600",children:n.profile?.name||"Назва не встановлена"})]}),e.jsx("button",{onClick:g,className:`px-4 py-2 mt-2 rounded-lg font-semibold transition ${i?"bg-green-500 text-white hover:bg-green-600":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:i?"Зберегти":"Редагувати"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsx("section",{className:"bg-white p-6 rounded-2xl shadow-sm border border-gray-100",children:e.jsx(j,{children:n.children,onRefresh:c})}),e.jsx("section",{className:"bg-white p-6 rounded-2xl shadow-sm border border-gray-100",children:e.jsx(N,{goals:n.goals,childrenList:n.children,onRefresh:c})})]})]})};export{w as FamilyControlPage};
